{# /app/cadastre_process/templates/results.html #}
{% extends "base.html" %}

{% block content %}
<style>
    /* Стили для шахматки */
    .checkerboard td {
        vertical-align: middle;
        min-width: 90px;
    }
    .checkerboard .floor-label {
        background-color: #e9ecef;
        position: sticky;
        left: 0;
        z-index: 1;
        min-width: 100px;
    }
    .deal-cell .prop-id { font-size: 1.1rem; }
    .deal-cell .area-diff { font-size: 0.8rem; }

    /* Убираем разделитель, т.к. таблицы теперь отдельные */
</style>
<div class="d-flex justify-content-between align-items-center mb-3">
    <h2>Результаты обработки</h2>
    <div>
        <a href="{{ url_for('cadastre_process.download_checkerboard') }}" class="btn btn-success">Скачать шахматку (Excel)</a>
        <a href="{{ url_for('cadastre_process.deals_list') }}" class="btn btn-primary">Перейти к списку сделок</a>
        <a href="{{ url_for('cadastre_process.upload_page') }}" class="btn btn-secondary">Вернуться к загрузке</a>
    </div>
</div>
<div class="card mb-4">
    <div class="card-body">
        <h4 class="card-title">Сводка по объекту</h4>
        <p class="fs-5">
            Всего найдено и обработано: <span class="fw-bold">{{ total_apartments }}</span> квартир.
        </p>

        {% if checkerboard %}
        <h5 class="mt-4">Шахматка расхождений по площади, м²</h5>

        {# --- НАЧАЛО ОБНОВЛЕННОГО ЦИКЛА: ГРУППИРОВКА ПО ПОДЪЕЗДАМ --- #}
        {% for section, floors in checkerboard.items() %}
            <h6 class="mt-4">Подъезд: <span class="fw-bold">{{ section }}</span></h6>
            <div class="table-responsive">
                <table class="table table-bordered text-center checkerboard">
                    <tbody>
                        {# Внутренний цикл по этажам (уже отсортированным) #}
                        {% for floor, apartments in floors.items() %}
                        <tr>
                            <td class="fw-bold floor-label">Этаж {{ floor }}</td>

                            {# Цикл по квартирам (уже отсортированным) #}
                            {% for deal in apartments %}
                                {% set diff = deal.area_diff %}
                                {# Выбираем цвет ячейки в зависимости от расхождения #}
                                {% if diff > 0.1 %}
                                    {% set bg_class = 'table-success' %}
                                {% elif diff < -0.1 %}
                                    {% set bg_class = 'table-danger' %}
                                {% else %}
                                    {% set bg_class = 'table-light' %}
                                {% endif %}
                            <td class="{{ bg_class }} deal-cell">
                                <div class="fw-bold prop-id">{{ deal.property_id }}</div>
                                <div class="area-diff">{{ '%+.2f'|format(diff) }}</div>
                            </td>
                            {% endfor %}
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% else %}
            <p class="text-muted">Нет данных для отображения.</p>
        {% endfor %}
        {# --- КОНЕЦ ОБНОВЛЕННОГО ЦИКЛА --- #}

        {% endif %}
    </div>
</div>
<p class="text-muted">Нажмите на категорию, чтобы развернуть список сделок.</p>

{# ... (остальная часть файла с аккордеоном остается без изменений) ... #}
{% macro render_deals_list(deals) %}
  {% if deals %}
    <ul class="list-group">
      {% for deal in deals %}
        <li class="list-group-item d-flex justify-content-between align-items-center">
          <div>
            <strong>Клиент:</strong> {{ deal.client_name or 'Имя не указано' }}, <strong>Квартира №:</strong> {{ deal.property_id }}
          </div>
          <span class="badge bg-primary rounded-pill">Расхождение: {{ deal.area_diff }} м²</span>
        </li>
      {% endfor %}
    </ul>
  {% else %}
    <p class="text-muted">В этой группе нет объектов.</p>
  {% endif %}
{% endmacro %}

<div class="accordion mt-4" id="resultsAccordion">
    <div class="accordion-item">
        <h2 class="accordion-header" id="headingOne">
            <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOne" aria-expanded="true" aria-controls="collapseOne">
                1) Без обременений ({{ results['1_no_issues']|length }} шт.)
            </button>
        </h2>
        <div id="collapseOne" class="accordion-collapse collapse show" aria-labelledby="headingOne" data-bs-parent="#resultsAccordion">
            <div class="accordion-body">
                {{ render_deals_list(results['1_no_issues']) }}
            </div>
        </div>
    </div>

    <div class="accordion-item">
        <h2 class="accordion-header" id="headingTwo">
            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseTwo" aria-expanded="false" aria-controls="collapseTwo">
                2) С долгом, без изменения площади ({{ results['2_debt_only']|length }} шт.)
            </button>
        </h2>
        <div id="collapseTwo" class="accordion-collapse collapse" aria-labelledby="headingTwo" data-bs-parent="#resultsAccordion">
            <div class="accordion-body">
                {{ render_deals_list(results['2_debt_only']) }}
            </div>
        </div>
    </div>

    <div class="accordion-item">
        <h2 class="accordion-header" id="headingFive">
            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseFive" aria-expanded="false" aria-controls="collapseFive">
                5) Без долга, с увеличением площади > 2 м² ({{ results['5_increase_only']|length }} шт.)
            </button>
        </h2>
        <div id="collapseFive" class="accordion-collapse collapse" aria-labelledby="headingFive" data-bs-parent="#resultsAccordion">
            <div class="accordion-body">
                {{ render_deals_list(results['5_increase_only']) }}
            </div>
        </div>
    </div>

    <div class="accordion-item">
        <h2 class="accordion-header" id="headingSix">
            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSix" aria-expanded="false" aria-controls="collapseSix">
                6) Без долга, с уменьшением площади > 2 м² ({{ results['6_decrease_only']|length }} шт.)
            </button>
        </h2>
        <div id="collapseSix" class="accordion-collapse collapse" aria-labelledby="headingSix" data-bs-parent="#resultsAccordion">
            <div class="accordion-body">
                {{ render_deals_list(results['6_decrease_only']) }}
            </div>
        </div>
    </div>

    <div class="accordion-item">
        <h2 class="accordion-header" id="headingThree">
            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseThree" aria-expanded="false" aria-controls="collapseThree">
                3) С долгом, с увеличением площади > 2 м² ({{ results['3_debt_and_increase']|length }} шт.)
            </button>
        </h2>
        <div id="collapseThree" class="accordion-collapse collapse" aria-labelledby="headingThree" data-bs-parent="#resultsAccordion">
            <div class="accordion-body">
                {{ render_deals_list(results['3_debt_and_increase']) }}
            </div>
        </div>
    </div>

    <div class="accordion-item">
        <h2 class="accordion-header" id="headingFour">
            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseFour" aria-expanded="false" aria-controls="collapseFour">
                4) С долгом, с уменьшением площади > 2 м² ({{ results['4_debt_and_decrease']|length }} шт.)
            </button>
        </h2>
        <div id="collapseFour" class="accordion-collapse collapse" aria-labelledby="headingFour" data-bs-parent="#resultsAccordion">
            <div class="accordion-body">
                {{ render_deals_list(results['4_debt_and_decrease']) }}
            </div>
        </div>
    </div>
</div>

<div class="card mt-4">
    <div class="card-header fw-bold">
        Скачать уведомления
    </div>
    <div class="card-body">
        <p>Нажмите на кнопку, чтобы скачать ZIP-архив с Word-документами для соответствующей группы.</p>
        <div class="d-grid gap-2 d-md-flex flex-wrap">
            {% for group_key, deals in results.items() %}
                {% if deals %} {# Показываем кнопку, только если в группе есть сделки #}
                    <a href="{{ url_for('cadastre_process.download_archive', group_key=group_key) }}" class="btn btn-outline-primary mb-2">
                        Скачать архив для группы №{{ group_key[0] }} ({{ deals|length }} док.)
                    </a>
                {% endif %}
            {% endfor %}
        </div>
    </div>
</div>
{% endblock %}